# How we boosted response time of a service 2.5x using a simple singleton

This is a story of a hard debugging process and an easy solution for a problem that we were facing at WeTransfer.

In the last few weeks, we started rolling out to production our new storage manager, Storm.

When we started to increase the rollout percentage, we noticed a problem that was affecting its performance, but we were not sure how much.

This service is written in Ruby and it uses the `aws-sdk` gem to interact with AWS S3 and SQS.

It's worth saying that I'm an experienced Ruby engineer but not so familiar with the AWS ecosystem.

## The problem

The problem started with us, asking help to the Platform team to figure out why some requests to the AWS metadata
end point took so much time. We found this information on Appsignal:

![image1](../debug-aws-assets/image1.png)

This endpoint always run on a specific IP, 169.254.169.254.

If I had seen this issue alone, I would have taken much more time to understand which part of the code does that because
as we can see, Appsignal gives no clue about the origin of the request (we asked them this feature).

Thanks to the engineers that are experienced with AWS, I saved some time with that.

Our services use this endpoint to get credentials. There are more details about how it works at [AWS website](https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_use_switch-role-ec2.html).

So, when I started to work on this issue, my first goal was to understand how the AWS gem manages credentials and when it
make these requests.

## Understanding how the AWS gem works

Storm has many AWS gems on its `Gemfile.lock` and I wanted to know where these requests were made.

Then I used a simple `grep` command in the staging console to find where this IP was used:

```
~/storm $ bundle info aws-sdk-core
  * aws-sdk-core (3.114.0)
  Path: /usr/local/bundle/gems/aws-sdk-core-3.114.0

~/storm $ grep -r 169.254.169.254 /usr/local/bundle/gems/
/usr/local/bundle/gems/aws-sdk-core-3.114.0/lib/aws-sdk-core/instance_profile_credentials.rb:    # @option options [String] :ip_address ('169.254.169.254')
/usr/local/bundle/gems/aws-sdk-core-3.114.0/lib/aws-sdk-core/instance_profile_credentials.rb:      @ip_address = options[:ip_address] || '169.254.169.254'
/usr/local/bundle/gems/aws-sdk-core-3.114.0/lib/aws-sdk-core/ec2_metadata.rb:    # @option options [String] :endpoint (169.254.169.254) The IMDS endpoint.
/usr/local/bundle/gems/aws-sdk-core-3.114.0/lib/aws-sdk-core/ec2_metadata.rb:      @endpoint = options[:endpoint] || '169.254.169.254'
```

Note: I run this grep command in staging because there are only Storm dependencies installed in this container. If I had grepped it in my laptop, it would have found gems that I use in other projects, because I don't use a gemset.

So, I had a file to start the investigation: `aws-sdk-core/instance_profile_credentials.rb`.

First, I tried to add a `raise '----here----'` in this class and run the tests to see if any test would stop at this break point to debug it. I got no success.

Note: To change the gem code, I opened it in my text editor with the command `bundle open aws-sdk-core`.
Note2: It's good to run [bundle pristine](https://bundler.io/v1.15/man/bundle-pristine.1.html) after that to restore the original files.

So, I thought there could be 2 possibilities:
- there were no tests covering this path
- this class is maybe used only in a production environment

Then, I started to search where this class was referenced inside the `aws-sdk-core` gem and I found it in the file [lib/aws-sdk-core/credential_provider_chain.rb](https://github.com/aws/aws-sdk-ruby/blob/7c730a81508981ec379920e04af60776fef69386/gems/aws-sdk-core/lib/aws-sdk-core/credential_provider_chain.rb#L166):

```ruby
def instance_profile_credentials(options)
  if ENV['AWS_CONTAINER_CREDENTIALS_RELATIVE_URI']
    ECSCredentials.new(options)
  else
    InstanceProfileCredentials.new(options)   # <------ here
  end
end
```

Then I added a `raise` in the method to see if any test was using it, and I had no success again.

```ruby
def instance_profile_credentials(options)
  raise 'aaaaaaaaaaa'
  if ENV['AWS_CONTAINER_CREDENTIALS_RELATIVE_URI']
    ECSCredentials.new(options)
  else
    InstanceProfileCredentials.new(options)   # <------ here
  end
end
```

So, I continued going up in the stack strace, trying to find a place where the break point would stop running the tests in my laptop.

Luckily, I found a point in the next interaction, in the method [providers](https://github.com/aws/aws-sdk-ruby/blob/7c730a81508981ec379920e04af60776fef69386/gems/aws-sdk-core/lib/aws-sdk-core/credential_provider_chain.rb#L21):

```ruby
def providers
  binding.pry        # <----- the test stopped here
  [
    [:static_credentials, {}],
    [:static_profile_assume_role_web_identity_credentials, {}],
    [:static_profile_sso_credentials, {}],
    [:static_profile_assume_role_credentials, {}],
    [:static_profile_credentials, {}],
    [:static_profile_process_credentials, {}],
    [:env_credentials, {}],
    [:assume_role_web_identity_credentials, {}],
    [:sso_credentials, {}],
    [:assume_role_credentials, {}],
    [:shared_credentials, {}],
    [:process_credentials, {}],
    [:instance_profile_credentials, {
      retries: @config ? @config.instance_profile_credentials_retries : 0,
      http_open_timeout: @config ? @config.instance_profile_credentials_timeout : 1,
      http_read_timeout: @config ? @config.instance_profile_credentials_timeout : 1
    }]
  ]
end
```
